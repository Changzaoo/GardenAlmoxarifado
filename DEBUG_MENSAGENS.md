# üîç DEBUG: Mensagens N√£o Aparecem

## üö® PROBLEMA IDENTIFICADO E CORRIGIDO

### **Mudan√ßas Feitas:**

1. ‚úÖ **Ordena√ß√£o simplificada**: Voltou para `orderBy('timestamp')` em vez de `timestampCliente`
2. ‚úÖ **Hook corrigido**: Removido uso incorreto de async/await
3. ‚úÖ **SendMessage simplificado**: Removida transa√ß√£o complexa que pode falhar
4. ‚úÖ **Tratamento de erros melhorado**: Fallback para mensagens n√£o criptografadas

---

## üîç CHECKLIST DE DEBUG

### **Passo 1: Verificar Regras do Firestore**

1. Acesse: https://console.firebase.google.com
2. V√° em Firestore Database > Regras
3. Verifique se tem estas regras:

```javascript
match /conversas/{conversaId} {
  allow read, create, update: if request.auth != null && 
                                  request.auth.uid in resource.data.participantes;
  
  match /mensagens/{mensagemId} {
    allow read, create: if request.auth != null;
    allow update, delete: if request.auth != null && 
                             resource.data.remetenteId == request.auth.uid;
  }
}

match /usuarios/{userId} {
  allow read: if request.auth != null;
  allow update: if request.auth != null && request.auth.uid == userId;
}
```

4. Se n√£o tem, adicione e publique

---

### **Passo 2: Verificar Console do Navegador**

1. Abra o app (F5 para recarregar)
2. Abra Console (F12)
3. V√° em "Mensagens"
4. Crie uma conversa
5. Envie uma mensagem: "Teste"

**Logs esperados ao ENVIAR:**
```
üì§ Tentando enviar mensagem: {...}
üöÄ Enviando mensagem para Firestore...
üì® sendMessage chamado: {...}
üë• Participantes: ["user1", "user2"]
üîê Criptografando mensagem...
üíæ Salvando mensagem no Firestore...
‚úÖ Mensagem salva com ID: abc123
üîÑ √öltima mensagem atualizada
üìä Contador atualizado
üéâ Mensagem enviada e criptografada!
‚úÖ Mensagem enviada com sucesso!
```

**Logs esperados ao RECEBER (destinat√°rio):**
```
üëÇ Escutando mensagens para conversa: xyz789
üì® Snapshot de mensagens recebido: 1
üîë Chave de descriptografia gerada
üîì Mensagem descriptografada
‚úÖ Mensagens processadas: 1
üì¨ Mensagens recebidas no hook: 1
```

---

### **Passo 3: Verificar Firestore**

1. Abra Firebase Console
2. V√° em Firestore Database
3. Navegue: `conversas` > {id da conversa} > `mensagens`

**Deve ter:**
- ‚úÖ Um documento com a mensagem
- ‚úÖ Campo `texto` criptografado: "U2FsdGVkX1+..."
- ‚úÖ Campo `remetenteId` com ID do remetente
- ‚úÖ Campo `timestamp` com data/hora

**Se N√ÉO tem documento:**
- ‚ùå Mensagem n√£o foi salva
- Veja logs: erro ao enviar?
- Veja regras: permiss√£o negada?

---

### **Passo 4: Verificar Estrutura da Conversa**

1. No Firestore, abra: `conversas` > {id da conversa}
2. Verifique os campos:

```javascript
{
  tipo: "privada",
  participantes: ["user1", "user2"],  // ‚Üê Deve ter ambos os IDs
  participantesInfo: {
    user1: { ... },
    user2: { ... }
  },
  ultimaMensagem: {
    texto: "Teste",  // ‚Üê Deve atualizar
    timestamp: ...
  }
}
```

**Se `participantes` estiver errado:**
- ‚ùå Conversa mal criada
- Recrie a conversa

---

## üêõ ERROS COMUNS E SOLU√á√ïES

### **Erro 1: `Missing or insufficient permissions`**

**Console mostra:**
```
‚ùå FirebaseError: Missing or insufficient permissions
```

**Causa:** Regras do Firestore n√£o aplicadas

**Solu√ß√£o:**
1. Aplicar regras do Passo 1
2. Aguardar 30 segundos
3. Recarregar p√°gina (F5)
4. Tentar novamente

---

### **Erro 2: `usuario is undefined`**

**Console mostra:**
```
‚ö†Ô∏è useMensagens: Usu√°rio n√£o est√° logado
‚ùå Usu√°rio n√£o est√° logado
```

**Causa:** Usu√°rio n√£o est√° autenticado

**Solu√ß√£o:**
1. Fazer logout
2. Fazer login novamente
3. Verificar localStorage:
   ```javascript
   // No console
   localStorage.getItem('usuario')
   ```
4. Se `null`, fazer login

---

### **Erro 3: Mensagem salva mas n√£o aparece**

**Firestore tem mensagem, mas n√£o aparece na tela**

**Debug:**

1. Verifique logs do destinat√°rio:
   ```
   üëÇ Escutando mensagens para conversa
   üì® Snapshot de mensagens recebido: X
   ```

2. Se `X = 0` (nenhuma mensagem):
   - ‚ùå Listener n√£o est√° pegando mensagens
   - Verifique se est√° na conversa certa
   - Verifique campo `conversaId` na mensagem

3. Se `X > 0` mas n√£o aparece:
   - ‚ùå Erro ao processar mensagens
   - Veja se tem erro vermelho ap√≥s "Snapshot recebido"
   - Pode ser erro de descriptografia

---

### **Erro 4: Texto aparece criptografado**

**Mensagem aparece como: `U2FsdGVkX1+...`**

**Causa:** Descriptografia falhou

**Debug:**

1. Verifique logs:
   ```
   üîë Chave de descriptografia gerada  ‚Üê Deve ter
   üîì Mensagem descriptografada       ‚Üê Deve ter
   ```

2. Se n√£o tem "üîì":
   - ‚ùå Descriptografia n√£o rodou
   - Verifique se `encrypted: true` no documento
   - Verifique se `currentUserId` est√° correto

3. Se tem "‚ùå Erro ao descriptografar":
   - Chave diferente do envio
   - Mensagem corrompida
   - Participantes da conversa mudaram

---

### **Erro 5: Listener n√£o inicia**

**Console n√£o mostra: "üëÇ Escutando mensagens"**

**Causa:** Hook n√£o chamou `listenToMessages`

**Debug:**

1. Verifique se conversa foi selecionada:
   ```javascript
   // No console
   console.log('conversaAtiva:', conversaAtiva)
   ```

2. Se `null`:
   - ‚ùå Conversa n√£o foi aberta
   - Clique na conversa para selecionar

3. Se tem conversa mas n√£o escuta:
   - ‚ùå Erro no useEffect
   - Veja console: erro vermelho?

---

## üß™ TESTE MANUAL COMPLETO

### **Teste 1: Criar Conversa e Enviar**

```
1. Usu√°rio A faz login
2. Vai em "Mensagens"
3. Clica no "+" azul
4. Seleciona Usu√°rio B
5. Conversa abre

Resultado esperado:
‚úÖ Tela de chat aparece
‚úÖ Input de mensagem vis√≠vel
‚úÖ Console mostra: "üëÇ Escutando mensagens"
```

### **Teste 2: Enviar Mensagem**

```
1. Usu√°rio A digita: "Teste 123"
2. Clica em enviar (ou Enter)

Console deve mostrar:
‚úÖ üì§ Tentando enviar mensagem
‚úÖ üöÄ Enviando mensagem
‚úÖ üîê Criptografando
‚úÖ üíæ Salvando
‚úÖ ‚úÖ Mensagem salva
‚úÖ üéâ Enviada e criptografada

Tela deve mostrar:
‚úÖ Bolha de mensagem do lado direito
‚úÖ Texto: "Teste 123"
‚úÖ Status: "enviada" ou √≠cone de check
```

### **Teste 3: Receber Mensagem**

```
1. Usu√°rio B (destinat√°rio) faz login
2. Vai em "Mensagens"
3. V√™ lista de conversas
4. Clica na conversa com Usu√°rio A

Console deve mostrar:
‚úÖ üëÇ Escutando mensagens
‚úÖ üì® Snapshot recebido: 1
‚úÖ üîë Chave gerada
‚úÖ üîì Descriptografada
‚úÖ ‚úÖ Mensagens processadas: 1

Tela deve mostrar:
‚úÖ Bolha de mensagem do lado esquerdo
‚úÖ Texto: "Teste 123"
‚úÖ Nome/foto do Usu√°rio A
```

---

## üìã CHECKLIST DE CONFIGURA√á√ÉO

**Antes de testar:**

- [ ] Regras do Firestore publicadas
- [ ] P√°gina recarregada (F5)
- [ ] Console aberto (F12)
- [ ] Dois usu√°rios logados (para testar envio/recebimento)

**Estrutura no Firestore:**

- [ ] Cole√ß√£o `conversas` existe
- [ ] Documentos de conversa t√™m campo `participantes`
- [ ] Subcole√ß√£o `mensagens` existe dentro de conversas
- [ ] Mensagens t√™m campos: `texto`, `remetenteId`, `timestamp`

**C√≥digo atualizado:**

- [ ] `src/services/mensagensService.js` atualizado
- [ ] `src/hooks/useMensagens.js` atualizado
- [ ] `src/services/cryptographyService.js` existe
- [ ] `crypto-js` instalado

---

## üîß COMANDOS DE DEBUG

### **Verificar se mensagem foi salva:**

```javascript
// No console do navegador (F12)

// 1. Obter ID da conversa atual
console.log('Conversa:', conversaAtiva?.id)

// 2. Ver no Firestore Console se tem mensagens
```

### **Verificar usu√°rio logado:**

```javascript
// No console
console.log('Usu√°rio:', localStorage.getItem('usuario'))

// Deve retornar JSON com id, nome, etc
// Se null, precisa fazer login
```

### **For√ßar refresh do listener:**

```javascript
// No console
// Sair e entrar na conversa novamente
// Ou recarregar a p√°gina (F5)
```

### **Ver todas as conversas:**

```javascript
// Firebase Console > Firestore
// Navegar para: conversas
// Ver todos os documentos
// Verificar campo 'participantes' em cada um
```

---

## üÜò SE NADA FUNCIONAR

### **√öltimo Recurso: Reset Completo**

1. **Limpar dados locais:**
   ```javascript
   // No console (F12)
   localStorage.clear()
   sessionStorage.clear()
   ```

2. **Recarregar p√°gina:** F5

3. **Fazer login novamente**

4. **Criar NOVA conversa** (n√£o usar conversa antiga)

5. **Enviar mensagem simples:** "teste"

6. **Verificar Firestore:** Mensagem deve aparecer

7. **Verificar regras:** Devem estar aplicadas

---

## üìä LOGS COMPLETOS ESPERADOS

### **Envio completo (sucesso):**

```
üì§ Tentando enviar mensagem: {conversaId: "abc", texto: "teste", ...}
üöÄ Enviando mensagem para Firestore...
üì® sendMessage chamado: {conversaId: "abc", remetenteId: "user1", tipo: "texto"}
üë• Participantes: ["user1", "user2"]
üîê Criptografando mensagem...
üíæ Salvando mensagem no Firestore...
‚úÖ Mensagem salva com ID: msg123
üîÑ √öltima mensagem atualizada
üìä Contador atualizado
üéâ Mensagem enviada e criptografada!
‚úÖ Mensagem enviada com sucesso!
```

### **Recebimento completo (sucesso):**

```
üëÇ Escutando mensagens para conversa: abc
üì® Snapshot de mensagens recebido: 1
üîë Chave de descriptografia gerada
üîì Mensagem descriptografada
‚úÖ Mensagens processadas: 1
üì¨ Mensagens recebidas no hook: 1
```

---

## üéØ RESULTADO ESPERADO

Ap√≥s seguir todos os passos:

1. ‚úÖ Mensagem √© enviada pelo Usu√°rio A
2. ‚úÖ Aparece no Firestore (criptografada)
3. ‚úÖ Aparece na tela do Usu√°rio A (descriptografada)
4. ‚úÖ Aparece na tela do Usu√°rio B (descriptografada)
5. ‚úÖ Contador de n√£o lidas atualiza
6. ‚úÖ √öltima mensagem atualiza na lista

---

## üìû COMO REPORTAR PROBLEMA

Se ainda n√£o funcionar, copie e me envie:

1. **Todos os logs do console** (F12 > Console > Copiar tudo)
2. **Screenshot do Firestore** (conversas e mensagens)
3. **Regras atuais** (Firestore > Regras > Copiar)
4. **Vers√£o do navegador** (Chrome, Firefox, etc)
5. **Erros vermelhos** (se houver)

---

**üîç Siga o checklist passo a passo e me avise onde parou!**
