rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // ========================================
    // FUNÃ‡Ã•ES AUXILIARES DE SEGURANÃ‡A
    // ========================================
    
    // Verificar se o usuÃ¡rio estÃ¡ autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Verificar se o usuÃ¡rio Ã© admin (nÃ­vel > 2 no novo sistema)
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/usuario/$(request.auth.uid)).data.nivel > 2;
    }
    
    // Verificar se o usuÃ¡rio Ã© o dono do recurso
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Validar timestamp (evita backdating/futuredating excessivo)
    // Permite atÃ© 5 minutos de diferenÃ§a para compensar relÃ³gios dessincronizados
    function isValidTimestamp(timestamp) {
      let diff = request.time.toMillis() - timestamp;
      return diff > -300000 && diff < 300000; // Â±5 minutos
    }
    
    // Verificar nÃ­vel mÃ­nimo de acesso
    function hasMinLevel(minLevel) {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/usuario/$(request.auth.uid)).data.nivel >= minLevel;
    }
    
    // ğŸ›¡ï¸ NOVA: Validar tamanho de documento (mÃ¡ximo 1MB)
    function isValidSize() {
      return request.resource.size() < 1048576; // 1MB
    }
    
    // ğŸ›¡ï¸ NOVA: Validar nÃºmero de campos (prevenir documentos muito grandes)
    function hasReasonableFieldCount() {
      return request.resource.data.keys().size() < 100;
    }
    
    // ğŸ›¡ï¸ NOVA: Verificar se usuÃ¡rio pertence ao mesmo setor/empresa
    function isSameSector(targetUserId) {
      let currentUser = get(/databases/$(database)/documents/usuario/$(request.auth.uid)).data;
      let targetUser = get(/databases/$(database)/documents/usuario/$(targetUserId)).data;
      return currentUser.setorId == targetUser.setorId && 
             currentUser.empresaId == targetUser.empresaId;
    }
    
    // ğŸ›¡ï¸ NOVA: Rate limiting por usuÃ¡rio (mÃ¡x 100 writes por minuto)
    // Nota: Firestore nÃ£o suporta rate limiting nativo, mas podemos contar operaÃ§Ãµes
    function withinRateLimit() {
      // Esta funÃ§Ã£o seria implementada com Cloud Functions
      // Por enquanto retorna true, mas serve como placeholder
      return true;
    }
    
    // ğŸ›¡ï¸ NOVA: Validar string nÃ£o vazia e com tamanho razoÃ¡vel
    function isValidString(str, maxLength) {
      return str is string && 
             str.size() > 0 && 
             str.size() <= maxLength;
    }
    
    // ğŸ›¡ï¸ NOVA: Validar que campos obrigatÃ³rios existem
    function hasRequiredFields(fields) {
      return request.resource.data.keys().hasAll(fields);
    }

    // ========================================
    // REGRA PADRÃƒO: NEGAR TUDO
    // ========================================
    match /{document=**} {
      allow read, write: if false;
    }

    // ========================================
    // TEMPLATES
    // ========================================
    match /templates/{templateId} {
      allow read: if isAuthenticated();
      allow write: if hasMinLevel(2) && 
                      isValidSize() && 
                      hasReasonableFieldCount();
    }

    // ========================================
    // USUÃRIOS
    // ========================================
    match /usuario/{userId} {
      // Leitura: Admin ou prÃ³prio usuÃ¡rio ou usuÃ¡rio do mesmo setor
      allow read: if isAdmin() || 
                     isOwner(userId) ||
                     (isAuthenticated() && isSameSector(userId));
      
      // CriaÃ§Ã£o: Apenas admin
      allow create: if isAdmin() && 
                       isValidSize() && 
                       hasRequiredFields(['usuario', 'nivel', 'ativo']) &&
                       isValidString(request.resource.data.usuario, 50);
      
      // AtualizaÃ§Ã£o: Admin ou prÃ³prio usuÃ¡rio
      // UsuÃ¡rio comum nÃ£o pode alterar seu prÃ³prio nÃ­vel
      allow update: if (isAdmin() || isOwner(userId)) && 
                       isValidSize() &&
                       (!('nivel' in request.resource.data.diff(resource.data).affectedKeys()) || isAdmin());
      
      // DeleÃ§Ã£o: Apenas admin
      allow delete: if isAdmin();
    }

    // ========================================
    // INVENTÃRIO
    // ========================================
    match /inventario/{itemId} {
      allow read: if isAuthenticated();
      
      allow create: if isAdmin() && 
                       isValidTimestamp(request.resource.data.timestamp) &&
                       isValidSize() &&
                       hasRequiredFields(['nome', 'quantidade', 'timestamp']);
      
      allow update: if isAdmin() && 
                       isValidTimestamp(request.resource.data.timestamp) &&
                       isValidSize();
      
      allow delete: if isAdmin();
    }

    // ========================================
    // DOCUMENTOS LEGAIS
    // ========================================
    match /legal/{docId} {
      allow read: if isAuthenticated();
      
      allow write: if hasMinLevel(2) && 
                      isValidSize() &&
                      hasReasonableFieldCount();
    }

    // ========================================
    // EMPRÃ‰STIMOS
    // ========================================
    match /emprestimos/{emprestimoId} {
      allow read: if isAuthenticated();
      
      allow create, update: if isAdmin() && 
                               isValidTimestamp(request.resource.data.timestamp) &&
                               isValidSize() &&
                               hasRequiredFields(['ferramenta', 'funcionario', 'timestamp']);
      
      allow delete: if isAdmin();
    }

    // ========================================
    // VERIFICAÃ‡Ã•ES MENSAIS (IMUTÃVEL APÃ“S CRIAÃ‡ÃƒO)
    // ========================================
    match /verificacoes_mensais/{verificacaoId} {
      allow read: if isAuthenticated();
      
      // ğŸ›¡ï¸ ImutÃ¡vel: apenas criaÃ§Ã£o e atualizaÃ§Ã£o (nÃ£o deleÃ§Ã£o)
      allow create: if isAdmin() && 
                       isValidSize() &&
                       hasReasonableFieldCount();
      
      allow update: if isAdmin() && 
                       isValidSize();
      
      allow delete: if false; // Nunca permitir deleÃ§Ã£o
    }

    // ========================================
    // FERRAMENTAS DANIFICADAS
    // ========================================
    match /ferramentas_danificadas/{ferramenta} {
      allow read: if isAuthenticated();
      
      allow create, update: if isAdmin() && 
                               isValidTimestamp(request.resource.data.timestamp) &&
                               isValidSize();
      
      allow delete: if isAdmin();
    }

    // ========================================
    // FERRAMENTAS PERDIDAS
    // ========================================
    match /ferramentas_perdidas/{ferramenta} {
      allow read: if isAuthenticated();
      
      allow create, update: if isAdmin() && 
                               isValidTimestamp(request.resource.data.timestamp) &&
                               isValidSize();
      
      allow delete: if isAdmin();
    }

    // ========================================
    // HISTÃ“RICO (IMUTÃVEL)
    // ========================================
    match /historico/{historicoId} {
      allow read: if isAuthenticated();
      
      // ğŸ›¡ï¸ ImutÃ¡vel: apenas criaÃ§Ã£o, nunca atualizaÃ§Ã£o ou deleÃ§Ã£o
      allow create: if isAdmin() && 
                       isValidSize() &&
                       hasRequiredFields(['acao', 'usuario', 'timestamp']);
      
      allow update, delete: if false; // HistÃ³rico Ã© imutÃ¡vel
    }

    // ========================================
    // SISTEMA DE MENSAGENS
    // ========================================
    match /conversas/{conversaId} {
      // Apenas participantes podem ver a conversa
      allow read: if isAuthenticated() && 
                     request.auth.uid in resource.data.participantes;
      
      // Criar conversa
      allow create: if isAuthenticated() && 
                       request.auth.uid in request.resource.data.participantes &&
                       isValidSize() &&
                       hasRequiredFields(['participantes', 'criadoEm']);
      
      // Atualizar conversa (adicionar participantes, etc)
      allow update: if isAuthenticated() && 
                       request.auth.uid in resource.data.participantes &&
                       isValidSize();
      
      // Deletar conversa
      allow delete: if isAuthenticated() && 
                       request.auth.uid in resource.data.participantes;
      
      // Mensagens dentro da conversa
      match /mensagens/{mensagemId} {
        // Apenas participantes da conversa podem ver mensagens
        allow read: if isAuthenticated() && 
                       request.auth.uid in get(/databases/$(database)/documents/conversas/$(conversaId)).data.participantes;
        
        // Criar mensagem (validar remetente)
        allow create: if isAuthenticated() && 
                         request.auth.uid in get(/databases/$(database)/documents/conversas/$(conversaId)).data.participantes &&
                         request.resource.data.remetenteId == request.auth.uid &&
                         isValidSize() &&
                         hasRequiredFields(['texto', 'remetenteId', 'timestamp']) &&
                         isValidString(request.resource.data.texto, 5000); // mÃ¡x 5000 chars
        
        // ğŸ›¡ï¸ Mensagens sÃ£o imutÃ¡veis (nÃ£o podem ser editadas ou deletadas)
        allow update, delete: if false;
      }
    }

    // ========================================
    // ANALYTICS DE ACESSO (APENAS LEITURA ADMIN)
    // ========================================
    match /analytics_acessos/{acessoId} {
      // Apenas admin nÃ­vel 4+ pode ler
      allow read: if hasMinLevel(4);
      
      // Qualquer usuÃ¡rio autenticado pode criar registro de acesso
      allow create: if isAuthenticated() && 
                       isValidSize() &&
                       hasRequiredFields(['userId', 'timestamp']);
      
      // ğŸ›¡ï¸ ImutÃ¡vel: nunca atualizar ou deletar
      allow update, delete: if false;
    }

    // ========================================
    // BACKUP TEST
    // ========================================
    match /backup_test/{docId} {
      allow read: if hasMinLevel(3);
      allow write: if hasMinLevel(3) && isValidSize();
    }

    // ========================================
    // SISTEMA DE PONTOS
    // ========================================
    match /pontos/{pontoId} {
      allow read: if isAuthenticated();
      
      // Criar ponto
      allow create: if isAuthenticated() && 
                       hasRequiredFields(['userId', 'timestamp', 'tipo']) &&
                       request.resource.data.userId == request.auth.uid &&
                       isValidSize();
      
      // Apenas admin pode atualizar/deletar pontos
      allow update, delete: if isAdmin();
    }

    // ========================================
    // WORK PONTO (CONTROLE DE PONTO)
    // ========================================
    match /WorkPonto/{pontoId} {
      allow read: if isAuthenticated();
      
      // Criar registro de ponto
      allow create: if isAuthenticated() && 
                       isValidSize() &&
                       hasReasonableFieldCount();
      
      // Apenas admin pode atualizar/deletar
      allow update, delete: if isAdmin();
    }

    // ========================================
    // ğŸ†• LOGS DE SEGURANÃ‡A (NOVO)
    // ========================================
    match /security_logs/{logId} {
      // Apenas admin pode ler logs
      allow read: if hasMinLevel(4);
      
      // Sistema pode criar logs
      allow create: if isAuthenticated() && 
                       isValidSize() &&
                       hasRequiredFields(['event', 'userId', 'timestamp']);
      
      // Logs sÃ£o imutÃ¡veis
      allow update, delete: if false;
    }

    // ========================================
    // ğŸ†• SESSÃ•ES ATIVAS (NOVO)
    // ========================================
    match /active_sessions/{sessionId} {
      // UsuÃ¡rio pode ver apenas suas prÃ³prias sessÃµes
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      
      // Criar sessÃ£o
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid &&
                       isValidSize();
      
      // UsuÃ¡rio pode encerrar suas prÃ³prias sessÃµes
      allow update, delete: if isAuthenticated() && 
                               resource.data.userId == request.auth.uid;
    }
  }
}
